name: Deploy to Ubuntu Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (下載程式碼)
        uses: actions/checkout@v3

      - name: Copy files via SSH (傳送檔案到伺服器)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          # 修正處：scp-action 不支援 exclude 參數，必須寫在 source 裡，並用驚嘆號 ! 來排除
          source: ".,!node_modules,!.git,!.github,!.output,!.nuxt"
          target: "~/web-server/web-traffic"

      - name: Remote SSH Commands (遠端執行重啟指令)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # 1. 進入專案目錄
            cd ~/web-server/web-traffic

            # 2. 停止舊容器
            docker compose down

            # 3. 重新建置並啟動新容器
            docker compose up -d --build

            # 4. 清除沒用到的舊映像檔 (節省空間)
            docker image prune -f
